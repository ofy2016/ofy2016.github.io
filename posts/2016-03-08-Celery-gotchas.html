<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="django,celery," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Celery is our go-to task manager when working with Python. It is feature rich, stable, fast and has clean interfaces. We usually end up using it either for high volumes of short tasks or low volumes o">
<meta property="og:type" content="article">
<meta property="og:title" content="译-使用 celery 时的 3 个坑">
<meta property="og:url" content="http://pylixm.cc/posts/2016-03-08-Celery-gotchas.html">
<meta property="og:site_name" content="PyLixm'Wiki">
<meta property="og:description" content="Celery is our go-to task manager when working with Python. It is feature rich, stable, fast and has clean interfaces. We usually end up using it either for high volumes of short tasks or low volumes o">
<meta property="og:updated_time" content="2016-05-29T02:40:54.257Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="译-使用 celery 时的 3 个坑">
<meta name="twitter:description" content="Celery is our go-to task manager when working with Python. It is feature rich, stable, fast and has clean interfaces. We usually end up using it either for high volumes of short tasks or low volumes o">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6216560945443898000,
      author: '博主'
    }
  };
</script>

  <title> 译-使用 celery 时的 3 个坑 | PyLixm'Wiki </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?6ae30333ba35ec34bf3c7d6471d7ba27";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <div style="display: none;">
    <script src="http://s6.cnzz.com/stat.php?id=1259027433&web_id=1259027433" type="text/javascript"></script>
  </div>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">PyLixm'Wiki</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                译-使用 celery 时的 3 个坑
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-03-08T00:00:00+08:00" content="2016-03-08">
              2016-03-08
            </time>
          </span>
         
          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/celery/" itemprop="url" rel="index">
                    <span itemprop="name">celery</span>
                  </a>
                </span>

                
                

              
            </span>
          
                   
          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/posts/2016-03-08-Celery-gotchas.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="posts/2016-03-08-Celery-gotchas.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/posts/2016-03-08-Celery-gotchas.html" class="leancloud_visitors" data-flag-title="译-使用 celery 时的 3 个坑">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数  </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Celery is our go-to task manager when working with Python. It is feature rich, stable, fast and has clean interfaces. We usually end up using it either for high volumes of short tasks or low volumes of long running ones (understand 10+ seconds, or even minutes in devo.ps’ case).</p>
<p>Celery’s feature set is a double edged sword though; it’s great once you got things set up, but getting there often means some amount of trial and errors. If you’re just getting started, go read “Celery Best Practices” by Deni Bertovic. Once you’re done, come back here and I’ll share a few more tips.</p>
<p>Celery 是Python开发者们常用到的一个任务管理器。它功能丰富，性能稳定，速度快，拥有清晰的接口。</p>
<p>无论是对大批量的短期任务还是长时间运行的任务（10s+，在devo.ps 的情况下甚至几分钟（原文：even minutes in devo.ps’ case) ），</p>
<p>我们都会使用它。</p>
<p>Celery 的功能是把双刃剑。一旦你的东西成功，他就是伟大的；但一旦失败，你就需要不断的尝试去解决错误。</p>
<p>如果你是初学者，建议去读 <a href="https://denibertovic.com/posts/celery-best-practices/" target="_blank" rel="external">“Celery Best Practices” by Deni Bertovic</a>。</p>
<p>您完成后，我给大家介绍几个技巧。</p>
<h3 id="Gotcha-1-You-can’t-spawn-processes-from-within-Celery-tasks"><a href="#Gotcha-1-You-can’t-spawn-processes-from-within-Celery-tasks" class="headerlink" title="Gotcha 1: You can’t spawn processes from within Celery tasks"></a>Gotcha 1: You can’t spawn processes from within Celery tasks</h3><p>You can usually stick to testing (and unit testing hopefully) your tasks outside of Celery. You will however sometimes run into the following error when spawning a process from within a Celery task:</p>
<pre><code>daemonic processes are not allowed to have children
</code></pre><p>We ran into this issue when trying to programmatically run Ansible playbooks within Celery. It was tricky to catch because it only surfaced when we upgraded to Celery 3.1.x. Turns out, any code attempting to create sub-processes using the multiprocessing module will fail. That can be hard to prevent or detect since you may not be aware that some of the libraries you use actually do that.</p>
<p>You can find a long thread discussing this on GitHub. It actually worked in older Celery versions (3.0.x) because of a bug masking it. To my understanding this problem arises from unix limitation and how the underlying billiard module is used.</p>
<p>There doesn’t seem to be clean solution for this one, but you can find some possible workarounds in the GitHub issue above. You can also use Celery 3.0.x or simply avoid using libraries that rely on multiprocessing.</p>
<h3 id="技巧一，-您不能在celery的任务中创建子进程"><a href="#技巧一，-您不能在celery的任务中创建子进程" class="headerlink" title="技巧一， 您不能在celery的任务中创建子进程"></a>技巧一， 您不能在celery的任务中创建子进程</h3><p>当你在测试辛辛苦苦写完的 <code>tasks</code> 时。当到创建子进程的 <code>task</code> 运行时，常会得到如下错误：</p>
<pre><code>daemonic processes are not allowed to have children
</code></pre><p>我们尝试在 <code>celery</code> 中运行Ansibe playbooks 时，出现了这个错误。这个错误是非常棘手的，在把 <code>celery</code> 升级到</p>
<p>3.1.x 后，任务尝试使用 <code>multiprocessing</code> 模块创建子进程的代码都出现错误。这是很难预防和发现的。</p>
<p>你可以再github 上找到很长的讨论。这个问题在老版本的 <code>celery 3.0.x</code> 可以运行，我怀疑是新版本的一个 bug 。</p>
<p>以我的理解，解决这个问题，应该从UNUIX限制和biliard模块底层来看。</p>
<p>这个问题似乎没有一个简洁的解决方案。但你可以从Github讨论的问题列表中，找到解决方案。你可以继续使用3.0.x 或干脆避免使用 <code>multiprocessing</code> 模块。</p>
<h3 id="Gotcha-2-Limitations-on-arguments-when-chaining-tasks"><a href="#Gotcha-2-Limitations-on-arguments-when-chaining-tasks" class="headerlink" title="Gotcha 2: Limitations on arguments when chaining tasks"></a>Gotcha 2: Limitations on arguments when chaining tasks</h3><p>We had a chain of Celery tasks where the first one had to pass multiple parameters to the following one. Diving into the documentation, we quickly realized it wasn’t as straightforward as it appeared: by default, each task in the chain will pass (multiple) arguments to the next one as a tuple.</p>
<h3 id="技巧二，-任务链中对参数的限制"><a href="#技巧二，-任务链中对参数的限制" class="headerlink" title="技巧二， 任务链中对参数的限制"></a>技巧二， 任务链中对参数的限制</h3><p>我们在使用Celery 的任务链时，第一个有多个参数的tasks 会传递给下一个。深入文档，会发现，它似乎不是那么简单。在默认情况下，任务链中任务会通过（多个）</p>
<p>参数会作为元组传递给下一个。</p>
<p>This leaves you two options:</p>
<p>Use a decorator on tasks to unpack the tuple or stick to a single argument (possibly a more complex one, e.g a class instance or dictionary).</p>
<p>Our unpack_tuple decorator looks like this:</p>
<pre><code>def unpack_tuple(f):
    @functools.wraps(f)
    def _wrapper(*args, **kwargs):
        if len(args) &gt; 0 and type(args[0]) == tuple:
            args = args[0] + args[1:]
        return f(*args, **kwargs)
    return _wrapper
And here’s how we used it:

chain(fetch_user.s(userid), process.s())

@task
def fetch_user(userid)
    # process
    return firstname, lastname

@task
@unwrap_tuple
def process(firstname, lastname)
    # Do processing
</code></pre><h3 id="Gotcha-3-Tasks-stay-queued-even-when-there-are-free-workers"><a href="#Gotcha-3-Tasks-stay-queued-even-when-there-are-free-workers" class="headerlink" title="Gotcha 3: Tasks stay queued even when there are free workers"></a>Gotcha 3: Tasks stay queued even when there are free workers</h3><p>We were running long running tasks (5+ minutes to provision new servers on EC2 &amp; Digital Ocean), usually only one at a time. We quickly noticed that when two tasks, or more, where triggered at the same time, second one would hang until the first one completed, even when we had plenty of available workers.</p>
<p>This is due to the way Celery acknowledges messages from the broker; the first worker would simply reserve the first task, then acknowledge it immediately after starting it, and proceed on reserve the following one.</p>
<p>To deal with it, simply use the following 2 settings:</p>
<ul>
<li><p><code>ACKS_LATE=True</code>: this ensures that the worker acks the task after it’s completed. If the worker crashes, it will just restart.</p>
</li>
<li><p><code>PREFETCH_MULTIPLIER=1</code>: this ensures that the worker process can reserve at most one un-acked task at a time. If this is used with <code>ACKS_LATE=False</code> (the default), the worker will reserve a task as soon as it starts processing the first one.</p>
</li>
</ul>
<p>Beware that setting <code>PREFETCH_MULTIPLAYER=0</code> means unlimited prefetching (not disable prefetching).</p>
<p>Understanding how <code>PREFETCH_MULTIPLAYER</code> and ACK_LATE work isn’t trivial, I recommend you spend some time reading the official documentation.</p>
<p>附：</p>
<p><a href="https://denibertovic.com/posts/celery-best-practices/" target="_blank" rel="external">celery 最佳实践</a></p>
<p><a href="http://www.celeryproject.org/community/" target="_blank" rel="external">官网问题汇总</a></p>
<hr>
<p><strong>ps: 个人英文水平有限，还请各位批评指正。</strong></p>

      
    </div>
    
    <div>
      
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/django/" rel="tag">#django</a>
          
            <a href="/tags/celery/" rel="tag">#celery</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/2016-03-07-Curl.html" rel="next" title="转载 - curl 命令详解">
                <i class="fa fa-chevron-left"></i> 转载 - curl 命令详解
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/2016-03-08-Mysql-python.html" rel="prev" title="python的MySQLdb模块 连接 mysql 错误 Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock'">
                python的MySQLdb模块 连接 mysql 错误 Can't connect to local MySQL server through socket '/var/lib/mysql/mysql.sock' <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="posts/2016-03-08-Celery-gotchas.html"
           data-title="译-使用 celery 时的 3 个坑" data-url="http://pylixm.cc/posts/2016-03-08-Celery-gotchas.html">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="PyLixm" />
          <p class="site-author-name" itemprop="name">PyLixm</p>
          <p class="site-description motion-element" itemprop="description">python, 自动化运维开发, django</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">48</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/pylixm" target="_blank" title="GitHub">
                  
                    <i class="fa fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element">
            <div class="links-of-blogroll-title">
              <i class="fa fa-globe fa-fw"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://iwebtools.cn" title="程序员集散地" target="_blank">程序员集散地</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Gotcha-1-You-can’t-spawn-processes-from-within-Celery-tasks"><span class="nav-number">1.</span> <span class="nav-text">Gotcha 1: You can’t spawn processes from within Celery tasks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#技巧一，-您不能在celery的任务中创建子进程"><span class="nav-number">2.</span> <span class="nav-text">技巧一， 您不能在celery的任务中创建子进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gotcha-2-Limitations-on-arguments-when-chaining-tasks"><span class="nav-number">3.</span> <span class="nav-text">Gotcha 2: Limitations on arguments when chaining tasks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#技巧二，-任务链中对参数的限制"><span class="nav-number">4.</span> <span class="nav-text">技巧二， 任务链中对参数的限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gotcha-3-Tasks-stay-queued-even-when-there-are-free-workers"><span class="nav-number">5.</span> <span class="nav-text">Gotcha 3: Tasks stay queued even when there are free workers</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PyLixm</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"pylixm"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  





  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("OBJcj4PU8JI0zDfu0HJSrG6W-gzGzoHsz", "tBtFzC72xIlgo2UFbA33nqmU");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
